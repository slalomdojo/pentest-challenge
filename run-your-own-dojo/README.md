# Introduction

This tutorial will explain in details how to launch the base infrastructure that was provided during the event so you can try to solve the challenge even if you didn't attend the event.

# TL;DR

Here's all steps you will need to perform in order to launch the base infrastructure:
 
1. Log in to your AWS account
2. Create a bucket for the Terraform state files (the name should be globally unique, but let's call it bucket-1 for the purpose of this tutorial)
3. Run a Docker command to launch the infra. Take a look at the **Step 2: Launching the base infrastructure** section.

# Step-By-Step

Here's a step by step so you can launch the base infrastructure:

## Step 0: Log in to your AWS account

If you don't have an AWS account, [create one first](https://aws.amazon.com/). If you do, log in now.

## Step 1: Create a bucket for Terraform state files

You will be using Terraform in a Docker container to launch the base infrastructure. Don't worry if you have never used Terraform before. A bash script will run all commands needed.
However, since Terraform keeps the state of the infrastructure in files, you don't want those files to be kept in a container that can die at any minute. Best practice is to keep the state files in a remote storage like S3.

[Follow these steps to create an S3 bucket](https://docs.aws.amazon.com/quickstarts/latest/s3backup/step-1-create-bucket.html). Name the bucket as you wish.

## Step 2: Accept the Terms and Conditions of the Kali Linux AMI

Before you can launch a Kali Linux instance on AWS, you need to accept Kali's terms and conditions. If you don't and you try to use Terraform, for example, to launch the instance, it will fail. Let's accept the terms and conditions first.

Head over to: [https://aws.amazon.com/marketplace/pp/B01M26MMTT](https://aws.amazon.com/marketplace/pp/B01M26MMTT)

Then click on **Continue to Subscribe**:

![Kali](./images/kali-tac-01.png)

Accept the Terms:

![Kali](./images/kali-tac-02.png)

After you accept, it may take a few seconds before you're subscribed to this product. You will see that the **Continue to Configuration** button is grayed out:

![Kali](./images/kali-tac-03.png)

After a few seconds/minutes, the **Continue to Configuration** button will become active. At that point, your account is subscribed to Kali Linux and you're ready to launch the base infrastructure:

![Kali](./images/kali-tac-04.png)

## Step 3: Launch the base infrastructure

### Build a Docker container

Before launching the infrastructure, you will need to build a Docker container. Run the following command:

```bash
docker build -t dojo-base:pentest .
```

### Run the container

The Docker command that you will have to run will take two environment variables as input. Let's first discuss each one of them so you understand them before running `docker run`.

### TERRAFORM_STATE_BUCKET_NAME
The name of the bucket for the Terraform state files that you created in **Step 1**.

### TEAMS
The number of teams that will need access to an attacker machine. If you specify `TEAMS` as `5`, then the Docker container will launch 5 attacker instances (and a single target instance). If you only need a single attacker instance for yourself, feel free to omit this environment variable (or just specify `1`).

The next thing you should understand is regarding how Terraform can make calls to the AWS API on your behalf. If you've used AWS before, you might know that users use an Access Key and a Secret Access Key to access the AWS API. These keys can be found in a file called `~/.aws/credentials`:

```
[default]
aws_access_key_id = AKIAIXXXXXXXXXXXXXXXX
aws_secret_access_key = XXXXXXXXXXXXXXXXXXXXXXXXXXX
```

You should also configure region and output using `~/.aws/config`:

```
[default]
region = us-east-1
output = json
```

What you need to do is to somehow give Terraform access to these files. In Docker, that can be achieved by mouting a volume. So in order to mount the `.aws` folder in your home directory to the docker container, you can use the `-v` option.

Run the following command and replace <HOME-DIRECTORY> with the actual path of your home directory, <TERRAFORM_STATE_BUCKET_NAME> with the name of the bucket for terraform state files and <TEAMS> with the number of teams (i.e. attacker instances) - beware that the syntax below is for Linux/Mac. If you're using Windows, the syntax might change slightly, like forward slash vs backslash:

```
docker run -it --rm \
    -v <HOME-DIRECTORY>/.aws/:/root/.aws \
    -e 'TERRAFORM_STATE_BUCKET_NAME=<TERRAFORM_STATE_BUCKET_NAME>' \
    -e "WORKSTATION_IP=`curl -Ss ifconfig.co`/32" \
    -e 'TEAMS=<TEAMS>' \
    dojo-base:pentest \
    ./deploy.sh
```

The command above will use Terraform to launch the base infrastructure needed to solve the challenge. Once it's done, the script will output the IP address of the attacker instance(s):

```
*****************************************************
Here are Attacker machine IP Addresses

Team 1: W.X.Y.Z
(...)
*****************************************************
```

If you see the message "Something went wrong with Terraform. Take a look at the error above.", well, the messages says it all :)

Here are a few things to watch out for:
* Make sure you **subscribed to the Kali Linux AMI** (see *Step 2: Accept the Terms and Conditions of the Kali Linux AMI*).
* When you provide a Workstation IP address, use `/32` at the end (e.g. XX.XX.XX.XX/32).
* You might hit some limit in your account. If that happens, request a limit increase to AWS via the Support console.

## Step 4: SSH into the Attacker instance

Before SSH'ing into the attacker instance, you will need to obtain the private key for the instance. When Terraform launched the infrastructure, it created an SSH key pair (public and private) and created a secret in Secrets Manager. This secret contains the private key for the attacker instance. Go to your AWS account and look for a secret called `/dojo/pentest/key-pair/private`. Please note that this private key is in OpenSSH format (if you're using PuTTY on Windows, you might need to convert it).

Once you have the key, you can SSH into the attacker instance:

```
ssh -i <PRIVATE-KEY-PATH> ec2-user@<ATTACKER-IP>
```

# Destroying the base infrastructure

Once you're done, run the same command you ran to deploy the infra, but specify `./destroy` instead of `./deploy`:

```
docker run -it --rm \
    -v <HOME-DIRECTORY>/.aws/:/root/.aws \
    -e 'TERRAFORM_STATE_BUCKET_NAME=<TERRAFORM_STATE_BUCKET_NAME>' \
    -e "WORKSTATION_IP=`curl -Ss ifconfig.co`/32" \
    -e 'TEAMS=<TEAMS>' \
    dojo-base:pentest \
    ./destroy.sh
```

# Cost

This is how much this base infrastructure will cost you **PER DAY** on AWS:
* Target machine (t2.micro): USD 0.28 / day
* Target machine EBS: USD 0.8 / day
* Attacker machine (t2.medium): USD 1.12 / day
* Attacker machine EBS: USD 2.50 / day

The majority of the prices above only applies to you if your AWS account **is not within the free tier period**. If your account is brand new, you will only pay for the Attacker machine. 

# Issues?

Please report any issues with this tutorial by opening a Pull Request or an Issue on GitHub.
